// ========== KONFIG ==========
const SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();
const FOLDER_ID = "1DMNybPr9lAjj8S5KIc74a4iDjJ50uehZQLa1Xmt1f-neAuvqtcJyUoahappcgHrNobo3J3LF";
const SHEET_NAME = "Respon"; 

function doPost(e) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000); 

    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sh = ss.getSheetByName(SHEET_NAME);

    if (!sh) throw new Error("Sheet '" + SHEET_NAME + "' tidak ditemukan.");

    let fileUrls = [];

    // 1. PROSES UPLOAD & OVERWRITE FILE
    if (data.files && data.files.length > 0) {
      const folder = DriveApp.getFolderById(FOLDER_ID);
      
      data.files.forEach((f, i) => {
        const safeName = data.nama.replace(/[^a-zA-Z0-9]/g, "_");
        const baseName = `${safeName}_${i + 1}`; // Contoh: ADI_1
        const fileName = `${baseName}.${f.ext}`;
        
        // --- LOGIKA PENGHAPUSAN FILE LAMA (OVERWRITE) ---
        // Mencari file yang namanya diawali dengan baseName (mengabaikan ekstensi)
        const existingFiles = folder.searchFiles("title contains '" + baseName + "'");
        while (existingFiles.hasNext()) {
          const oldFile = existingFiles.next();
          // Pastikan nama file benar-benar sama sebelum ekstensi (menghindari ADI_11 ikut terhapus)
          const oldFileNameNoExt = oldFile.getName().substring(0, oldFile.getName().lastIndexOf('.'));
          if (oldFileNameNoExt === baseName) {
            oldFile.setTrashed(true); // Memindahkan file lama ke sampah
          }
        }
        // ------------------------------------------------
        
        const blob = Utilities.newBlob(Utilities.base64Decode(f.data), f.type, fileName);
        const createdFile = folder.createFile(blob);
        fileUrls.push(createdFile.getUrl()); 
      });
    }

    const fileLinks = fileUrls.join(", ");

    // 2. SIMPAN DATA KE SHEET
    sh.appendRow([
      new Date(),
      data.kelas,
      "'" + data.nisn.toString().trim(),
      "'" + data.nis.toString().trim(),
      data.nama.trim(),
      data.tempat_lahir.trim(),
      data.tanggal_lahir,
      data.jenis_kelamin,
      data.agama,
      data.alamat.trim(),
      data.kecamatan.trim(),
      "'" + data.hp.toString().trim(),
      data.nama_ayah.trim(),
      data.pekerjaan_ayah,
      data.pendidikan_ayah,
      data.penghasilan_ayah,
      data.nama_ibu.trim(),
      data.pekerjaan_ibu,
      data.pendidikan_ibu,
      data.penghasilan_ibu,
      data.hobi,
      data.cita,
      data.transport,
      data.jarak,
      fileLinks            
    ]);

    return ContentService.createTextOutput(JSON.stringify({ "status": "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ "status": "error", "message": err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}