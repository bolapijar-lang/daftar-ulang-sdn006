// ========== KONFIG ==========
// SPREADSHEET_ID sekarang otomatis mengambil ID tempat skrip ini berada
const SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();

// Folder ID tetap manual karena Google Drive tidak tahu Anda ingin simpan di mana
const FOLDER_ID = "1coXPqTP2aYz_C_DWH9NvP6g6zpeJox6k3FrFYhUe_9uV9ybPx2E5At__BtS0PhxGIT26M7_A";
const SHEET_NAME = "Respon"; 

function doPost(e) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000); 

    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sh = ss.getSheetByName(SHEET_NAME);

    if (!sh) throw new Error("Sheet '" + SHEET_NAME + "' tidak ditemukan.");

    let fileUrls = [];

    // 1. PROSES UPLOAD & RENAME FILE
    if (data.files && data.files.length > 0) {
      const folder = DriveApp.getFolderById(FOLDER_ID);
      data.files.forEach((f, i) => {
        // Nama file dibersihkan dari karakter aneh
        const safeName = data.nama.replace(/[^a-zA-Z0-9]/g, "_");
        const fileName = `${safeName}_${i + 1}.${f.ext}`;
        const blob = Utilities.newBlob(Utilities.base64Decode(f.data), f.type, fileName);
        const createdFile = folder.createFile(blob);
        fileUrls.push(createdFile.getUrl()); 
      });
    }

    const fileLinks = fileUrls.join(", ");

    // 2. SIMPAN DATA
    // Menggunakan tanda "'" agar nol di depan dan digit panjang tidak rusak/menjadi format ilmiah
    sh.appendRow([
      new Date(),
      data.kelas,
      "'" + data.nisn.toString().trim(),      // WAJIB 10 Digit
      "'" + data.nis.toString().trim(),       // MAKS 10 Digit
      data.nama.trim(),
      data.tempat_lahir.trim(),
      data.tanggal_lahir,
      data.jenis_kelamin,
      data.agama,
      data.alamat.trim(),
      data.kecamatan.trim(),
      "'" + data.hp.toString().trim(),        // MAKS 13 Digit
      data.nama_ayah.trim(),
      data.pekerjaan_ayah,
      data.pendidikan_ayah,
      data.penghasilan_ayah,
      data.nama_ibu.trim(),
      data.pekerjaan_ibu,
      data.pendidikan_ibu,
      data.penghasilan_ibu,
      data.hobi,
      data.cita,
      data.transport,
      data.jarak,
      fileLinks            
    ]);

    return ContentService.createTextOutput(JSON.stringify({ "status": "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ "status": "error", "message": err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}