// ================== KONFIG ==================
const SPREADSHEET_ID = "1PWqmsM36FX7NryG6hLkjcUG3gwW-I_8TAhBzcRIC884";
const FOLDER_ID = "1coXPqTP2aYz_C_DWH9NvP6g6zpeJox6k3FrFYhUe_9uV9ybPx2E5At__BtS0PhxGIT26M7_A";
const SHEET_NAME = "Respon"; // Pastikan nama tab di Sheet Anda adalah 'Respon'

function doPost(e) {
  // Gunakan LockService agar jika 100 orang klik 'Kirim' bersamaan, data masuk satu per satu (antre)
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000); // Tunggu antrean maksimal 30 detik

    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sh = ss.getSheetByName(SHEET_NAME);

    if (!sh) throw new Error("Sheet '" + SHEET_NAME + "' tidak ditemukan.");

    let fileUrls = [];

    // 1. PROSES UPLOAD & RENAME FILE
    if (data.files && data.files.length > 0) {
      const folder = DriveApp.getFolderById(FOLDER_ID);

      data.files.forEach((f, i) => {
        // Skrip Rename: NamaSiswa_Index.ext
        const fileName = `${data.nama}_${i + 1}.${f.ext}`;
        const blob = Utilities.newBlob(Utilities.base64Decode(f.data), f.type, fileName);
        const createdFile = folder.createFile(blob);
        fileUrls.push(createdFile.getUrl()); // Simpan URL untuk dimasukkan ke Sheet
      });
    }

    const fileLinks = fileUrls.join(", ");

    // 2. SIMPAN DATA KE SPREADSHEET (Dengan tanda ' agar angka aman)
    sh.appendRow([
      new Date(),
      data.kelas,
      "'" + data.nisn,      // Aman dari format ilmiah
      "'" + data.nis,       // Aman dari nol hilang
      data.nama,
      data.tempat_lahir,
      data.tanggal_lahir,
      data.jenis_kelamin,
      data.agama,
      data.alamat,
      data.kecamatan,
      "'" + data.hp,        // Aman dari nol hilang
      data.nama_ayah,
      data.pekerjaan_ayah,
      data.pendidikan_ayah,
      data.penghasilan_ayah,
      data.nama_ibu,
      data.pekerjaan_ibu,
      data.pendidikan_ibu,
      data.penghasilan_ibu,
      data.hobi,
      data.cita,
      data.transport,
      data.jarak,
      fileLinks            // Link file dicatat di kolom terakhir (PENTING)
    ]);

    return ContentService.createTextOutput(JSON.stringify({ "status": "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ "status": "error", "message": err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock(); // Lepas kunci antrean
  }
}
