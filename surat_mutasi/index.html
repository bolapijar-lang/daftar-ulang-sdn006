<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Layanan Mutasi - SDN 006 Sungai Pinang</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    :root {
      --primary-dark: #0f172a;
      --accent-color: #1e293b;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --input-border: #e2e8f0;
    }

    body { 
      background: #f8fafc; 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      color: #334155;
      background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
      background-size: 30px 30px;
    }

    /* Header Modern */
    .blue-header { 
      background: var(--primary-dark); 
      color: white; 
      padding: 30px 15px; 
      text-align: center; 
      font-weight: 800; 
      font-size: 1.5rem; 
      letter-spacing: 2px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border-bottom: 4px solid #3b82f6;
    }

    /* Card Styling */
    .main-card { 
      max-width: 650px; 
      margin: 40px auto; 
      background: var(--glass-bg); 
      border-radius: 24px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.08); 
      overflow: hidden; 
      border: 1px solid #ffffff;
      backdrop-filter: blur(10px);
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Section Divider */
    .section-divider { 
      background: #f1f5f9;
      padding: 12px 20px;
      margin: 25px 0 15px 0;
      font-weight: 800; 
      color: var(--primary-dark); 
      text-transform: uppercase; 
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-divider::before {
      content: ''; width: 4px; height: 18px; background: #3b82f6; border-radius: 10px;
    }

    /* Input Styling */
    label { font-size: 0.85rem; font-weight: 700; color: #475569; margin-bottom: 8px; padding-left: 5px; }
    .form-group { margin-bottom: 1.5rem; padding: 0 25px; }
    .form-control, .form-select { 
      padding: 12px 18px; 
      border-radius: 14px; 
      border: 1.5px solid var(--input-border);
      background: #ffffff;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }
    .form-control:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      background: #fff;
    }
    .readonly-field { background-color: #f8fafc !important; font-weight: 600; color: #64748b; border-style: dashed; }

    /* Button Styling */
    .btn-primary { background: #3b82f6; border: none; border-radius: 14px; padding: 15px; font-weight: 800; transition: all 0.3s; }
    .btn-primary:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3); }
    .btn-success { background: #10b981; border: none; border-radius: 14px; }

    /* Home Section Styles */
    #home-section { 
      border-radius: 24px; 
      border: 1px solid #fff;
      transition: 0.3s;
    }
    .nisn-input-box {
      background: #f1f5f9;
      padding: 25px;
      border-radius: 20px;
      margin-bottom: 20px;
    }

    .hidden { display: none; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; visibility: hidden; }
    
    /* Mobile Adjustments */
    @media (max-width: 576px) {
      .main-card { margin: 15px; border-radius: 16px; }
      .blue-header { font-size: 1.1rem; padding: 20px 10px; }
      .form-group { padding: 0 15px; }
    }
  </style>
</head>
<body>

<div id="loading">
  <div class="text-center">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-3 fw-bold">Sinkronisasi Database...</div>
  </div>
</div>

<div class="blue-header">SD NEGERI 006 SUNGAI PINANG</div>

<div class="container">
  <div id="home-section" class="main-card p-4 p-md-5 text-center mt-5">
    <div class="mb-4">
      <div class="d-inline-block p-4 rounded-circle bg-primary bg-opacity-10 mb-3">
        <i class="bi bi-shield-lock-fill text-primary" style="font-size: 3rem;"></i>
      </div>
      <h3 class="fw-extrabold">Layanan Mutasi Siswa</h3>
      <p class="text-muted">Gunakan NISN Siswa untuk Membuka Formulir Pengajuan</p>
    </div>

    <div class="nisn-input-box mx-auto" style="max-width: 400px;">
      <label class="text-center w-100 mb-2">IDENTITAS AKSES</label>
      <input type="text" id="inputNisnKunci" class="form-control form-control-lg text-center fw-bold shadow-sm" placeholder="--- MASUKKAN NISN ---" inputmode="numeric">
      <button id="btnVerifikasi" class="btn btn-primary w-100 mt-3 py-3 shadow" onclick="verifikasiAkses()">
        <i class="bi bi-unlock-fill me-2"></i>BUAT FORMULIR BARU
      </button>
    </div>
    <small class="text-secondary"><i class="bi bi-info-circle me-1"></i> hanya siswa yang terdaftar dalam database</small>
  </div>

  <div id="form-section" class="main-card hidden">
    <div class="p-3 bg-primary bg-opacity-10 text-center border-bottom">
      <h6 class="fw-bold mb-0 text-primary"><i class="bi bi-pencil-square me-2"></i>FORMULIR DIGITAL MUTASI KELUAR</h6>
    </div>

    <form id="mutasiForm">
      <div class="section-divider">1. Identitas Siswa Terdata</div>
      <div class="row px-2">
        <div class="col-md-6 form-group">
          <label>Kelas Aktif</label>
          <input type="text" id="kelas" class="form-control readonly-field" readonly>
        </div>
        <div class="col-md-6 form-group">
          <label>NISN</label>
          <input type="text" id="nisn" class="form-control readonly-field" readonly>
        </div>
      </div>
      <div class="form-group">
        <label>Nama Lengkap Siswa</label>
        <input type="text" id="nama" class="form-control readonly-field" readonly>
      </div>
      <div class="form-group">
        <label>Jenis Kelamin</label>
        <input type="text" id="jk" class="form-control readonly-field" readonly>
      </div>

      <div class="row px-2">
        <div class="col-md-6 form-group">
          <label>Tempat Lahir</label>
          <input type="text" id="tempatLahir" class="form-control readonly-field" readonly>
        </div>
        <div class="col-md-6 form-group">
          <label>Tanggal Lahir</label>
          <input type="text" id="tanggalLahir" class="form-control readonly-field" readonly>
        </div>
      </div>

      <div class="section-divider">2. Tujuan & Lokasi Mutasi</div>
      <div class="form-group">
        <label>Nama Sekolah Tujuan</label>
        <input type="text" id="sekolahTujuan" class="form-control" placeholder="Contoh: SD NEGERI 001 SAMARINDA" required oninput="tutupKecil(this); validate()">
      </div>
      <div class="form-group">
        <label>NPSN Sekolah Tujuan (Opsional)</label>
        <input type="text" id="npsn" class="form-control" placeholder="Masukkan 8 digit NPSN" oninput="validate()">
      </div>
      <div class="form-group">
        <label>Alamat Sekolah Tujuan</label>
        <input type="text" id="alamat" class="form-control" placeholder="Nama Jalan / Kampung" oninput="kapitalAwal(this); validate()">
      </div>
      <div class="row px-2">
        <div class="col-md-6 form-group"><label>Kelurahan</label><input type="text" id="kel" class="form-control" oninput="kapitalAwal(this); validate()"></div>
        <div class="col-md-6 form-group"><label>Kecamatan</label><input type="text" id="kec" class="form-control" oninput="kapitalAwal(this); validate()"></div>
      </div>
      <div class="row px-2">
        <div class="col-md-6 form-group"><label>Kota/Kabupaten</label><input type="text" id="kota" class="form-control" required oninput="kapitalAwal(this); validate()"></div>
        <div class="col-md-6 form-group"><label>Provinsi</label><input type="text" id="prov" class="form-control" required oninput="kapitalAwal(this); validate()"></div>
      </div>

      <div class="section-divider">3. Validasi Dokumen</div>
      <div class="row px-2">
        <div class="col-md-6 form-group">
          <label>Tanggal Efektif Mutasi</label>
          <input type="date" id="tglMutasi" class="form-control" required onchange="validate()">
        </div>
        <div class="col-md-6 form-group">
          <label>Keterangan Status</label>
          <input type="text" id="keterangan" class="form-control readonly-field" value="Mutasi" readonly>
        </div>
      </div>
      <div class="form-group">
        <label>Upload Surat Rekomendasi (PDF/JPG)</label>
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-cloud-arrow-up"></i></span>
          <input type="file" id="fileIn" class="form-control" required onchange="validate()">
        </div>
      </div>

      <div class="form-group">
        <div class="alert alert-warning border-0 rounded-4 p-3 mb-0">
          <div class="d-flex gap-2">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <small>Pastikan data benar. Dokumen PDF akan digenerate otomatis berdasarkan isian ini.</small>
          </div>
        </div>
      </div>

      <div class="px-4 pb-4">
        <button type="submit" id="btn" class="btn btn-primary w-100 py-3 fw-bold" disabled>KIRIM & PROSES DOKUMEN</button>
        <div class="text-center mt-3">
          <a href="#" onclick="showSection('home')" class="text-secondary small text-decoration-none">
            <i class="bi bi-arrow-left"></i> Batal dan Kembali
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // URL Web App dari GAS
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzwCjKV8I2-74bt8uSV2QrfjGS0x85tyONiPBKj8Pv01rrfWxOt9Lsmm9-IqUjcCvqmaA/exec";
  let master = [];

  window.onload = () => { 
    document.getElementById('loading').style.visibility = 'visible';
    fetch(`${WEB_APP_URL}?action=getSiswa`)
      .then(res => res.json())
      .then(d => {
        master = d;
        document.getElementById('loading').style.visibility = 'hidden';
      })
      .catch(err => {
        Swal.fire('Error', 'Gagal memuat database!', 'error');
        document.getElementById('loading').style.visibility = 'hidden';
      });
  };

  function tutupKecil(el) { el.value = el.value.toUpperCase(); }

  function kapitalAwal(el) {
    let str = el.value;
    str = str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
    el.value = str;
  }

  function verifikasiAkses() {
    const nisnInput = document.getElementById('inputNisnKunci').value.trim();
    if (!nisnInput) {
      Swal.fire({ icon: 'warning', text: 'Harap Masukkan NISN !', confirmButtonColor: '#3b82f6' });
      return;
    }

    const siswa = master.find(x => String(x.nisn).trim() === nisnInput);
    if (siswa) {
      Swal.fire({
        title: 'Akses Diterima!',
        html: `Selamat Datang,<br><b>${siswa.nama}</b>`,
        icon: 'success', timer: 1500, showConfirmButton: false,
        didClose: () => {
          showSection('form');
          ['kelas','nama','nisn','jk','tempatLahir','tanggalLahir'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = siswa[id] || "";
          });
          // Fix untuk format tanggal lahir jika dari GAS bentuknya beda
          if(siswa.tanggalLahir) document.getElementById('tanggalLahir').value = siswa.tanggalLahir;
          validate();
        }
      });
    } else {
      Swal.fire({ icon: 'error', title: 'Tidak Ditemukan', text: 'NISN tidak terdaftar di database SDN 006!', confirmButtonColor: '#ef4444' });
    }
  }

  function showSection(s) { 
    document.getElementById('home-section').classList.toggle('hidden', s !== 'home');
    document.getElementById('form-section').classList.toggle('hidden', s !== 'form');
    window.scrollTo(0,0);
  }

  function validate() {
    const v = (id) => document.getElementById(id).value;
    const isOk = (v('sekolahTujuan') && v('kota') && v('prov') && v('tglMutasi') && document.getElementById('fileIn').files.length > 0);
    const btn = document.getElementById('btn');
    btn.disabled = !isOk;
    if(isOk) {
      btn.className = "btn btn-success w-100 py-3 fw-bold shadow";
    } else {
      btn.className = "btn btn-primary w-100 py-3 fw-bold";
    }
  }

  document.getElementById('mutasiForm').onsubmit = function(e) {
    e.preventDefault();
    const b = document.getElementById('btn'); 
    b.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memproses Database...'; 
    b.disabled = true;
    
    const file = document.getElementById('fileIn').files[0];
    const reader = new FileReader();
    reader.onload = function(r) {
      const payload = {
        obj: {
          kelas: document.getElementById('kelas').value, 
          nama: document.getElementById('nama').value, 
          jk: document.getElementById('jk').value,
          nisn: document.getElementById('nisn').value, 
          tempatLahir: document.getElementById('tempatLahir').value,
          tanggalLahir: document.getElementById('tanggalLahir').value, 
          sekolahTujuan: document.getElementById('sekolahTujuan').value,
          npsn: document.getElementById('npsn').value, 
          alamat: document.getElementById('alamat').value, 
          kelurahan: document.getElementById('kel').value, 
          kecamatan: document.getElementById('kec').value, 
          kota: document.getElementById('kota').value, 
          provinsi: document.getElementById('prov').value,
          keterangan: document.getElementById('keterangan').value,
          tanggalMutasi: document.getElementById('tglMutasi').value
        },
        fileData: {data: r.target.result.split(',')[1], type: file.type}
      };

      fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) })
      .then(res => res.json())
      .then(res => {
        if(res.status === "Sukses") {
          Swal.fire({
            title: 'Berhasil Terkirim!',
            html: `Data <b>${res.nama}</b> telah diperbarui.<br><br>` +
                  `<button id="downloadBtn" class="btn btn-danger w-100 py-3 fw-bold">` +
                  `<i class="bi bi-file-pdf me-2"></i>UNDUH SURAT MUTASI (PDF)</button>`,
            icon: 'success',
            confirmButtonText: 'Selesai',
            confirmButtonColor: '#0f172a',
            didOpen: () => {
              document.getElementById('downloadBtn').onclick = () => {
                const byteCharacters = atob(res.pdfData);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], {type: 'application/pdf'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = res.fileName;
                link.click();
              };
            }
          }).then(() => { location.reload(); });
        } else {
          Swal.fire('Gagal', res.message, 'error');
          b.innerHTML = 'KIRIM & PROSES DOKUMEN'; b.disabled = false;
        }
      })
      .catch(err => {
        Swal.fire('Error', 'Gagal terhubung ke server!', 'error');
        b.innerHTML = 'KIRIM & PROSES DOKUMEN'; b.disabled = false;
      });
    };
    reader.readAsDataURL(file);
  };
</script>
</body>
</html>