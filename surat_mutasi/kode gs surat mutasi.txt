var SS_ID = "1xdiI9SEAybDosLmOmGvSa9_e0lMvVK5HWGpZpuPDLlQ"; 
var FOLDER_ID = "1FtP9q4A-CmKspG05i35y-SDvKmvCrm-lsuU49ir4czdE3-VVL3sptS5RfC48p6dCU49qP2Sz";
// PASTIKAN ID TEMPLATE INI SUDAH BENAR
var TEMPLATE_ID = "1UKd8DYjV07OaNq8-lqF0rSozO8WxMXRUk0xmdUf5zVU"; 

function doGet(e) {
  var action = e.parameter.action;
  if (action === "getSiswa") {
    var sheet = SpreadsheetApp.openById(SS_ID).getSheetByName("database");
    var data = sheet.getDataRange().getDisplayValues(); 
    var dataSiswa = data.slice(1).map(function(r) {
      return {
        kelas: r[1], nama: r[2], jk: r[3], nisn: r[4], tempatLahir: r[7], tanggalLahir: r[8]
      };
    });
    return ContentService.createTextOutput(JSON.stringify(dataSiswa)).setMimeType(ContentService.MimeType.JSON);
  }
  return HtmlService.createTemplateFromFile('Index').evaluate().setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var obj = data.obj;
    var fileData = data.fileData;
    var ss = SpreadsheetApp.openById(SS_ID);
    var sheetMutasi = ss.getSheetByName("mutasi");
    var folder = DriveApp.getFolderById(FOLDER_ID);
    
    // 1. UPLOAD FILE BUKTI
    var fileUrl = "-";
    if (fileData) {
      var blobBukti = Utilities.newBlob(Utilities.base64Decode(fileData.data), fileData.type, "BUKTI_" + obj.nama.toUpperCase());
      fileUrl = folder.createFile(blobBukti).getUrl();
    }

    // 2. SIMPAN DATA KE SHEET MUTASI
    sheetMutasi.appendRow([
      new Date(), obj.kelas, obj.nama, obj.jk, obj.nisn, obj.tempatLahir, obj.tanggalLahir, 
      obj.sekolahTujuan, obj.npsn, obj.alamat, obj.kelurahan, obj.kecamatan, obj.kota, obj.provinsi,
      "Mutasi", obj.tanggalMutasi, fileUrl 
    ]);

    // 3. AUTO GENERATE DOKUMEN (GOOGLE DOC EDITABLE)
    var copyFile = DriveApp.getFileById(TEMPLATE_ID).makeCopy("SURAT_MUTASI_" + obj.nama.toUpperCase(), folder);
    
    // TAMBAHKAN JEDA INI AGAR TIDAK ERROR "INACCESSIBLE"
    Utilities.sleep(1500); 

    var doc = DocumentApp.openById(copyFile.getId());
    var body = doc.getBody();
    
    // REVISI: Pemisahan Tempat dan Tanggal Lahir
    body.replaceText("<<Nama>>", obj.nama);
    body.replaceText("<<NISN>>", obj.nisn);
    body.replaceText("<<jk>>", obj.jk);
    body.replaceText("<<Tempat>>", obj.tempatLahir); // Terpisah
    body.replaceText("<<Tanggal Lahir>>", obj.tanggalLahir); // Terpisah
    body.replaceText("<<Kelas>>", obj.kelas);
    body.replaceText("<<SD Tujuan>>", obj.sekolahTujuan);
    body.replaceText("<<NPSN>>", obj.npsn);
    body.replaceText("<<Kelurahan>>", obj.kelurahan);
    body.replaceText("<<Kecamatan>>", obj.kecamatan);
    body.replaceText("<<Kota>>", obj.kota);
    body.replaceText("<<Provinsi>>", obj.provinsi);
    body.replaceText("<<mutasi>>", "Mutasi");
    body.replaceText("<<tanggal mutasi>>", obj.tanggalMutasi);
    
    doc.saveAndClose();

    return ContentService.createTextOutput(JSON.stringify({
      "status": "Sukses",
      "nama": obj.nama
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({
      "status": "Error",
      "message": "Gagal: " + err.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}