<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Layanan Mutasi - SDN 006 Sungai Pinang</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background-color: #f4f7fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
    .blue-header { 
      background: #1a237e; color: white; padding: 25px 10px; text-align: center; 
      font-weight: 800; font-size: 1.8rem; letter-spacing: 5px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; text-transform: uppercase; 
    }
    .main-card { max-width: 600px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow: hidden; }
    .section-divider { border-left: 5px solid #1a237e; padding-left: 15px; margin: 30px 20px 15px 20px; font-weight: 700; color: #1a237e; text-transform: uppercase; font-size: 0.9rem; }
    .readonly-field { background-color: #f8f9fa !important; border: 1px solid #dee2e6 !important; font-weight: 600; color: #555; }
    label { font-size: 0.85rem; font-weight: 700; color: #333; margin-bottom: 5px; display: block; padding-left: 20px; }
    .form-group { margin-bottom: 1.2rem; }
    .form-control, .form-select { width: calc(100% - 40px); margin: 0 20px; border-radius: 8px; }
    .btn-submit { margin: 20px; width: calc(100% - 40px); padding: 15px; font-weight: 700; border-radius: 8px; transition: 0.3s; }
    .hidden { display: none; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; visibility: hidden; }
  </style>
</head>
<body>

<div id="loading"><div class="spinner-border text-primary"></div><span class="ms-2 fw-bold">Sedang memuat data...</span></div>
<div class="blue-header">SD NEGERI 006 SUNGAI PINANG</div>

<div class="container">
  <div id="home-section" class="text-center p-5 bg-white rounded-3 shadow-sm mx-auto mt-4" style="max-width: 700px;">
    <i class="bi bi-file-earmark-lock2-fill text-primary" style="font-size: 4rem;"></i>
    <h4 class="fw-bold mt-3">Layanan Mutasi Siswa</h4>
    <p class="text-muted mb-4">Silakan masukkan NISN untuk mengakses formulir.</p>
    <div class="mb-3 mx-auto" style="max-width: 320px;">
      <input type="text" id="inputNisnKunci" class="form-control text-center fw-bold p-3 border-primary" placeholder="MASUKKAN NISN SISWA" inputmode="numeric">
    </div>
    <button id="btnVerifikasi" class="btn btn-primary btn-lg px-5 fw-bold w-100 shadow" onclick="verifikasiAkses()">BUAT FORMULIR BARU</button>
  </div>

  <div id="form-section" class="main-card hidden">
    <div class="p-3 bg-light border-bottom text-center"><h6 class="fw-bold mb-0">PENGAJUAN MUTASI KELUAR</h6></div>
    <form id="mutasiForm">
      <div class="section-divider">1. Identitas Siswa</div>
      <div class="form-group"><label>Kelas</label><input type="text" id="kelas" class="form-control readonly-field" readonly></div>
      <div class="form-group"><label>Nama Lengkap</label><input type="text" id="nama" class="form-control readonly-field" readonly></div>
      <div class="form-group"><label>NISN</label><input type="text" id="nisn" class="form-control readonly-field" readonly></div>
      <div class="form-group"><label>Jenis Kelamin</label><input type="text" id="jk" class="form-control readonly-field" readonly></div>
      <div class="form-group"><label>Tempat Lahir</label><input type="text" id="tempatLahir" class="form-control readonly-field" readonly></div>
      <div class="form-group"><label>Tanggal Lahir</label><input type="text" id="tanggalLahir" class="form-control readonly-field" readonly></div>

      <div class="section-divider">2. Data Sekolah Tujuan</div>
      <div class="form-group"><label>Nama Sekolah Tujuan</label><input type="text" id="sekolahTujuan" class="form-control" required oninput="tutupKecil(this); validate()"></div>
      <div class="form-group"><label>NPSN</label><input type="text" id="npsn" class="form-control" oninput="validate()"></div>
      <div class="form-group"><label>Alamat Sekolah</label><input type="text" id="alamat" class="form-control" oninput="kapitalAwal(this); validate()"></div>
      <div class="form-group"><label>Kelurahan</label><input type="text" id="kel" class="form-control" oninput="kapitalAwal(this); validate()"></div>
      <div class="form-group"><label>Kecamatan</label><input type="text" id="kec" class="form-control" oninput="kapitalAwal(this); validate()"></div>
      <div class="form-group"><label>Kota/Kabupaten</label><input type="text" id="kota" class="form-control" required oninput="kapitalAwal(this); validate()"></div>
      <div class="form-group"><label>Provinsi</label><input type="text" id="prov" class="form-control" required oninput="kapitalAwal(this); validate()"></div>

      <div class="section-divider">3. Dokumen & Mutasi</div>
      <div class="form-group"><label>Tanggal Mutasi</label><input type="date" id="tglMutasi" class="form-control" required onchange="validate()"></div>
      <div class="form-group"><label>Upload Surat Rekomendasi (PDF/Gambar)</label><input type="file" id="fileIn" class="form-control" required onchange="validate()"></div>
      <div class="form-group">
        <div class="bg-light p-3 rounded border mx-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cek" required onchange="validate()">
            <label class="form-check-label fw-bold p-0" for="cek">Saya menyatakan data ini benar (Mutasi)</label>
          </div>
        </div>
      </div>

      <button type="submit" id="btn" class="btn btn-primary btn-submit" disabled>KIRIM & PROSES</button>
      <div class="text-center pb-3"><a href="#" onclick="showSection('home')" class="text-muted small text-decoration-none">Batal dan Kembali</a></div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz7Gm7oXVdrXezLP4ZZDU7wirp5kl3qB8dBDHqoh9ohVRj8tsEQN4CClRT7mHc-60y_/exec";
  let master = [];

  window.onload = () => { 
    document.getElementById('loading').style.visibility = 'visible';
    fetch(`${WEB_APP_URL}?action=getSiswa`)
      .then(res => res.json())
      .then(d => {
        master = d;
        document.getElementById('loading').style.visibility = 'hidden';
      })
      .catch(err => {
        Swal.fire('Error', 'Gagal memuat database!', 'error');
        document.getElementById('loading').style.visibility = 'hidden';
      });
  };

  /**
   * FUNGSI AUTOMATISASI TEKS (EYD)
   * 1. tutupKecil: Mengubah semua input menjadi huruf KAPITAL.
   * 2. kapitalAwal: Mengubah huruf pertama setiap kata jadi kapital & kapital setelah tanda titik (.).
   */
  function tutupKecil(el) {
    el.value = el.value.toUpperCase();
  }

  function kapitalAwal(el) {
    let str = el.value;
    // Kapital di awal kata
    str = str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
    // Kapital setelah titik (Contoh: Jl. Raya)
    str = str.replace(/\.\s*([a-z])/g, (m, g) => ". " + g.toUpperCase());
    el.value = str;
  }

  function verifikasiAkses() {
  // Ambil input sebagai string murni dan hapus spasi jika ada
  const nisnInput = document.getElementById('inputNisnKunci').value.trim();
  
  if (!nisnInput) {
    Swal.fire({ icon: 'warning', text: 'Harap Masukkan NISN !', confirmButtonColor: '#d33' });
    return;
  }

  // Cari di master dengan mengubah keduanya menjadi string murni
  const siswa = master.find(x => String(x.nisn).trim() === nisnInput);
  
    if (siswa) {
      Swal.fire({
        title: 'Akses Diterima! âœ…',
        html: `Selamat Datang,<br><b>${siswa.nama}</b>`,
        icon: 'success', timer: 1500, showConfirmButton: false,
        didClose: () => {
          showSection('form');
          ['kelas','nama','nisn','jk','tempatLahir','tanggalLahir'].forEach(id => {
            document.getElementById(id).value = siswa[id] || "";
          });
          validate();
        }
      });
    } else {
      Swal.fire({ icon: 'error', title: 'Tidak Ditemukan', text: 'NISN tidak terdaftar !', confirmButtonColor: '#d33' });
    }
  }

  function showSection(s) { 
    document.getElementById('home-section').classList.toggle('hidden', s !== 'home');
    document.getElementById('form-section').classList.toggle('hidden', s !== 'form');
  }

  function validate() {
    const v = (id) => document.getElementById(id).value;
    const isOk = (v('nama') && v('sekolahTujuan') && v('kota') && v('prov') && v('tglMutasi') && document.getElementById('fileIn').files.length > 0 && document.getElementById('cek').checked);
    const btn = document.getElementById('btn');
    btn.disabled = !isOk;
    btn.className = isOk ? "btn btn-success btn-submit shadow" : "btn btn-primary btn-submit";
  }

  document.getElementById('mutasiForm').onsubmit = function(e) {
    e.preventDefault();
    const b = document.getElementById('btn'); 
    b.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memproses...'; 
    b.disabled = true;
    
    const file = document.getElementById('fileIn').files[0];
    const reader = new FileReader();
    reader.onload = function(r) {
      const payload = {
        obj: {
          kelas: document.getElementById('kelas').value, 
          nama: document.getElementById('nama').value, 
          jk: document.getElementById('jk').value,
          nisn: document.getElementById('nisn').value, 
          tempatLahir: document.getElementById('tempatLahir').value,
          tanggalLahir: document.getElementById('tanggalLahir').value, 
          sekolahTujuan: document.getElementById('sekolahTujuan').value,
          npsn: document.getElementById('npsn').value, 
          alamat: document.getElementById('alamat').value, 
          kelurahan: document.getElementById('kel').value, 
          kecamatan: document.getElementById('kec').value, 
          kota: document.getElementById('kota').value, 
          provinsi: document.getElementById('prov').value,
          tanggalMutasi: document.getElementById('tglMutasi').value
        },
        fileData: {data: r.target.result.split(',')[1], type: file.type}
      };

      fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) })
      .then(res => res.json())
      .then(res => {
        if(res.status === "Sukses") {
          Swal.fire({
            title: 'Berhasil Terkirim! ðŸ“„',
            html: `Data <b>${res.nama}</b> telah dicatat.<br><br>` +
                  `<button id="downloadBtn" class="btn btn-danger fw-bold shadow-sm" style="width: 85%; max-width: 300px; border-radius: 5px !important; padding: 12px; font-size: 0.9rem; border: none;">` +
                  `<i class="bi bi-file-pdf"></i> UNDUH SURAT MUTASI (PDF)</button>`,
            icon: 'success',
            confirmButtonText: 'Selesai',
            confirmButtonColor: '#1a237e',
            didOpen: () => {
              document.getElementById('downloadBtn').onclick = () => {
                const byteCharacters = atob(res.pdfData);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], {type: 'application/pdf'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = res.fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              };
            }
          }).then(() => { location.reload(); });
        } else {
          Swal.fire('Gagal', res.message, 'error');
          b.innerHTML = 'KIRIM & PROSES'; b.disabled = false;
        }
      })
      .catch(err => {
        Swal.fire('Error', 'Gagal terhubung!', 'error');
        b.innerHTML = 'KIRIM & PROSES'; b.disabled = false;
      });
    };
    reader.readAsDataURL(file);
  };
</script>
</body>
</html>