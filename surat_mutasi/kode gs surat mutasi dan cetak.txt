var SS_ID = "1TvpmJgB58UL4Z1O46-0J7XfMHLeXtqVwTvmLWRlgDwQ"; 
var FOLDER_ID = "1FtP9q4A-CmKspG05i35y-SDvKmvCrm-lsuU49ir4czdE3-VVL3sptS5RfC48p6dCU49qP2Sz";
var TEMPLATE_ID = "1UKd8DYjV07OaNq8-lqF0rSozO8WxMXRUk0xmdUf5zVU"; 

function doGet(e) {
  var action = e.parameter.action;
  if (action === "getSiswa") {
    var sheet = SpreadsheetApp.openById(SS_ID).getSheetByName("database");
    var data = sheet.getDataRange().getDisplayValues(); 
    var dataSiswa = data.slice(1).map(function(r) {
      return { kelas: r[1], nama: r[2], jk: r[3], nisn: r[4], tempatLahir: r[7], tanggalLahir: r[8] };
    });
    return ContentService.createTextOutput(JSON.stringify(dataSiswa)).setMimeType(ContentService.MimeType.JSON);
  }
  return HtmlService.createTemplateFromFile('Index').evaluate().setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var obj = data.obj;
    var fileData = data.fileData;
    var ss = SpreadsheetApp.openById(SS_ID);
    var sheetMutasi = ss.getSheetByName("mutasi");
    var folder = DriveApp.getFolderById(FOLDER_ID);

    // --- 1. PROSES WAKTU UNTUK FOOTNOTE ---
    var sekarang = new Date();
    // Kita buat format dd/MM/yyyy HH:mm langsung di sini
    var teksTimestamp = Utilities.formatDate(sekarang, "GMT+8", "dd/MM/yyyy HH:mm");
    
    var tglSplit = obj.tanggalMutasi.split("-"); 
    var tglLabel = tglSplit[2] + "-" + tglSplit[1] + "-" + tglSplit[0].substring(2); 
    
    // --- 2. SOLUSI AGAR ANGKA NOL (0) TIDAK HILANG ---
    // Tambahkan kutip satu (') agar Spreadsheet menganggapnya teks murni
    var nisnFix = "'" + obj.nisn;
    var npsnFix = "'" + obj.npsn;

    var fileUrl = "-";
    if (fileData) {
      var namaFileBukti = "BUKTI_" + obj.nama.toUpperCase() + "_" + tglLabel;
      var blobBukti = Utilities.newBlob(Utilities.base64Decode(fileData.data), fileData.type, namaFileBukti);
      fileUrl = folder.createFile(blobBukti).getUrl();
    }

    // --- 3. INPUT DATA KE SHEET ---
    sheetMutasi.appendRow([
      sekarang, obj.kelas, obj.nama, obj.jk, nisnFix, obj.tempatLahir, obj.tanggalLahir, 
      obj.sekolahTujuan, npsnFix, obj.alamat, obj.kelurahan, obj.kecamatan, obj.kota, obj.provinsi,
      "Mutasi", obj.tanggalMutasi, fileUrl 
    ]);

    SpreadsheetApp.flush(); 
    Utilities.sleep(1200); 
    
    var lastRow = sheetMutasi.getLastRow();
    // Mengambil tanggal mutasi dari Kolom P (16) yang sudah diformat Indonesia di Sheet
    var tanggalMutasiDariSheet = sheetMutasi.getRange(lastRow, 16).getDisplayValue();

    // --- 4. OLAH DOKUMEN ---
    var namaDocBaru = "SURAT_MUTASI_" + obj.nama.toUpperCase() + "_" + tglLabel;
    var copyFile = DriveApp.getFileById(TEMPLATE_ID).makeCopy(namaDocBaru, folder);
    var docUrl = copyFile.getUrl();
    
    // Link surat otomatis masuk ke Kolom R (18)
    sheetMutasi.getRange(lastRow, 18).setValue(docUrl);

    var doc = DocumentApp.openById(copyFile.getId());
    var body = doc.getBody();
	
    // Replace Data Utama
    body.replaceText("<<Nama>>", obj.nama);
    body.replaceText("<<NISN>>", obj.nisn);
    body.replaceText("<<jk>>", obj.jk);
    body.replaceText("<<Tempat>>", obj.tempatLahir);
    body.replaceText("<<Tanggal Lahir>>", obj.tanggalLahir);
    body.replaceText("<<Kelas>>", obj.kelas);
    body.replaceText("<<SD Tujuan>>", obj.sekolahTujuan);
    body.replaceText("<<NPSN>>", obj.npsn);
    body.replaceText("<<Alamat>>", obj.alamat);
    body.replaceText("<<Kelurahan>>", obj.kelurahan);
    body.replaceText("<<Kecamatan>>", obj.kecamatan);
    body.replaceText("<<Kota>>", obj.kota);
    body.replaceText("<<Provinsi>>", obj.provinsi);
    body.replaceText("<<mutasi>>", "Mutasi");
    
    // Tanggal Tanda Tangan (mengambil dari kolom P)
    body.replaceText("<<tanggal mutasi>>", tanggalMutasiDariSheet);

    // FOOTNOTE (Sekarang diletakkan di Body paling bawah)
    body.replaceText("<<timestamp>>", teksTimestamp);
    	
    doc.saveAndClose();
	
    // --- 5. GENERATE PDF ---
    Utilities.sleep(1500); 
    var pdfBlob = copyFile.getAs(MimeType.PDF);
    var pdfBase64 = Utilities.base64Encode(pdfBlob.getBytes());
    var namaFileFix = "SURAT_MUTASI_" + obj.nama.toUpperCase().replace(/\s+/g, '_') + ".pdf";

    return ContentService.createTextOutput(JSON.stringify({
      "status": "Sukses", 
      "nama": obj.nama,
      "pdfData": pdfBase64,
      "fileName": namaFileFix
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({
      "status": "Error", 
      "message": err.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}